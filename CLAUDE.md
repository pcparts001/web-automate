# Chrome自動操作ツール - 開発状況

## プロジェクト概要
AI chat applications（特にGenspark.ai）向けのChrome自動操作ツール。プロンプトを送信し、ストリーミング応答の完了を検出して、応答をMarkdownファイルに自動保存する。サーバー側エラーの自動検出・リトライ機能とGradio Web GUIを搭載。

### 🚨 **重要: 安定版コミット情報**
**41d0ced1929b5f3f561c9e6be760988a2fcd9326** - 2025-07-20 11:06:59 UTC
- **重要度**: 🔴 **CRITICAL - 絶対に動作する安定版**
- **状況**: ストリーミング処理・再生成検出・GUI全機能が完全動作
- **機能**: プロンプトフロー、リスト管理、設定永続化、エラーリトライ
- **検証**: 3回連続テスト成功、300秒長時間応答対応
- **注意**: このコミットより新しいバージョンは不安定な可能性あり
- **戻し方**: `git checkout 41d0ced` で即座に安定版に復帰可能

### 📋 **現在の運用状況（2025-07-20 23:30）**
- **運用中バージョン**: 41d0ced安定版に統一完了
- **GitHub master**: 41d0cedにforce pushでリセット済み
- **全検証環境**: 安定版への統一作業中
- **Gradio互換性問題**: 41d0ced使用により解決済み
- **追加開発**: tkinter エディタ＋reload機能実装済み（別ブランチ）

### 🔧 **Gradio イベントハンドラーエラーの解決**
- **問題**: ValueError: An event handler didn't receive enough input values (needed: 1, got: 0)
- **エラー詳細**: Number コンポーネントへの入力が期待されているが受け取れない
- **段階的特定結果**: 
  - 段階1（メソッドのみ）: 問題なし
  - 段階2（単発プロンプト用ボタン）: 問題なし  
  - 段階3（プロンプトフロー用ボタン追加）: エラー発生
- **問題箇所**: プロンプトフロー用の「⏸️ フロー停止」ボタン追加時
- **推定原因**: プロンプトフロー部分のイベントハンドラー設定に問題

### 🔧 **過去のGradio 4.44.1 互換性問題**
- **問題**: .then()チェーンによるfunction index mismatch (KeyError: 23)
- **根本原因**: Gradio内部関数インデックス管理の変更
- **解決方法**: 安定版41d0cedの継続使用
- **代替案**: tkinter独立エディタ + 手動reload機能で拡張性確保

## 現在の実装状況

### ✅ 完了済み機能
1. **基本的なChrome自動操作**
   - Seleniumによる自動ブラウザ制御
   - Mac M1/M2対応のChromeDriver設定
   - ユーザープロファイル保持によるログイン状態維持

2. **Genspark.ai向け特化機能**
   - 自動ナビゲーション (`https://www.genspark.ai/agents?type=moa_chat`)
   - テキスト入力フィールド自動検出
   - 送信ボタン検出（Enterキー送信対応）

3. **ストリーミング応答検出システム**
   - "Thinking..."インジケーター検出
   - コピーボタン出現による完了判定
   - プロンプト特定コピーボタン検出（古いコピーボタンを除外）
   - Stale element reference対策

4. **継続的プロンプト処理**
   - 無限ループでの複数プロンプト送信
   - 連番ファイル保存 (`output_001_YYYYMMDD_HHMMSS.md`)
   - quit/exit コマンドでの終了

5. **最新応答検出アルゴリズム**
   - `message-content-id` 属性による最新応答特定
   - プロンプト送信前後の応答数比較
   - 応答内容検証（キーワードマッチング）

6. **再生成エラー自動検出・リトライ機能**
   - 「応答を再生成」ボタンの自動検出
   - 最大20回の自動リトライ処理
   - 1-5秒のランダム待機時間
   - JavaScript強制クリック対応

7. **Gradio Web GUI インターフェース**
   - URLナビゲーション機能
   - プロンプト入力・送信
   - フォールバックメッセージ自動送信
   - リアルタイムステータス表示
   - Chrome持続性管理

8. **設定永続化機能（Phase 0実装）**
   - フォールバックメッセージデフォルトON
   - JSON形式での設定自動保存・復元
   - URL、プロンプトA/B/C、フォールバックメッセージの永続化
   - ツール再起動時の設定復元

9. **プロンプトフロー自動化システム（Phase 1実装）**
   - A→(B→C)*無限循環型プロンプト送信
   - プロンプトA: 初期プロンプト（1回のみ）
   - プロンプトB/C: 交互繰り返し送信（無限ループ）
   - 各プロンプト間5-30秒ランダム待機
   - 全応答の自動Markdownファイル保存
   - エラー時フォールバックリトライ対応

10. **プロンプトリスト管理システム（Phase 2実装）**
    - プロンプトリスト編集専用タブ
    - A/B/Cプロンプトの独立リスト管理
    - 完全CRUD操作（作成・読み取り・更新・削除）
    - ランダムプロンプト選択機能
    - 「リストを使用」チェックボックス制御
    - リスト永続化ストレージ（JSON形式）

### 🔧 最近修正した問題
1. **エラーメッセージ誤認識の修正**
   - 「応答の生成中にエラーが発生しま」をエラーメッセージとして正しく識別
   - エラー状態時のストリーミング処理を無効化
   - 60秒タイムアウトと15秒待機を回避

2. **フォールバック処理時のThinking状態除外**
   - `wait_for_streaming=False` 時の「Thinking...」要素を候補から除外
   - フォールバック処理での適切な応答要素選択
   - ストリーミングタイムアウトの防止

3. **連続フォールバック処理の実装**
   - 最大20回の連続フォールバック試行
   - ランダム待機時間（1-5秒）の追加
   - 詳細なリトライ進捗表示

4. **リトライ回数の可視化**
   - ログメッセージに「(X回目)」表示
   - デバッグしやすいリトライ追跡機能
   - GUI での進捗状況表示

5. **Thinking終了後のエラー検出強化（2025-07-20）**
   - Thinking状態終了直後に5秒待機を追加
   - デュアルエラー検出システム実装（テキスト + DOM要素）
   - どちらの検出方法が成功したかの詳細ログ出力

6. **ストリーミング処理フローの可視化強化（2025-07-20）**
   - `wait_for_streaming` パラメータ値の明示的ログ出力
   - Thinking状態の事前チェックと検出キーワード表示
   - ストリーミング待機開始/スキップの理由明示

7. **メッセージ送信処理の簡素化（2025-07-20）**
   - 送信方法A（ボタンクリック）とB（JavaScriptフォーム送信）をコメントアウト
   - Enterキーのみを使用するシンプルな送信処理に変更
   - 無駄な試行処理を除去して高速化

8. **再生成ボタン検出の優先度変更とロジック統一（2025-07-20）**
   - ストリーミング監視で再生成ボタンチェックを最優先に変更
   - 軽量版とフルバージョンの検出ロジックを統一（厳格なAND条件）
   - 「応答を再生成」テキスト + div.buttonクラスの両方を満たす要素のみ検出
   - Thinkingチェック問題を解決し、早期エラー検出を実現

9. **Thinking状態終了判定の詳細分析強化（2025-07-20）**
   - Thinking終了時の詳細ログ追加（なぜ終了したかの分析）
   - テキスト変化の追跡機能（前回との差分表示）
   - is_thinking_state()のFalse理由を明示
   - `█`文字の消失による正常終了パターンを確認

10. **長時間応答対応の強化（2025-07-20）**
    - ストリーミング待機タイムアウトを60秒→300秒に延長
    - リトライ回数を20回→100回に増加
    - 本番環境の長い応答に対応

11. **ファイル重複保存問題の修正（2025-07-20）**
    - process_single_prompt メソッドに save_file パラメータ追加
    - GUI側でファイル保存制御、重複保存を防止
    - タイムアウト値を正式に300秒に統一

12. **Gradio Numberコンポーネント参照不整合エラーの修正（2025-07-21）**
    - `ValueError: An event handler didn't receive enough input values` エラーを解決
    - `flow_stop_btn`に`bc_loop_input`をダミーinputとして追加
    - 同一コンテキスト内でのNumberコンポーネント参照一貫性を確保
    - プロンプト停止機能（Chrome保持）の完全実装が完了

13. **プロンプトセット管理システムの段階的実装（2025-07-21）**
    - 統合プロンプトリスト機能からプロンプトセット管理への発展
    - Gradioエラー発生によりロールバック→段階的アプローチに変更
    - 新ブランチ`prompt-set-management-v2`で慎重な実装を継続中
    
    **完了済みStage**:
    - ✅ Stage 1: 統合リスト表示（読み取り専用） - コミット1cf4e79
    - ✅ Stage 2: 統合リスト追加機能 - コミット2ac026d  
    - ✅ Stage 3: プロンプトセット管理メソッド追加（UIなし） - コミットbef5a84
    - ✅ Stage 4: prompt_sets データ構造実装・自動移行機能 - コミット81a1f32
    - ✅ Stage 5: 最小限UI追加（読み取り専用Textbox） - コミットc48e245
    
    **現在の状況（2025-07-21）**:
    - ブランチ: `prompt-set-management-v2`
    - 最新コミット: `c48e245`
    - 動作確認: Stage 5まで全てGradioエラーなしで動作
    - 次予定: Stage 6（Dropdown追加）またはStage 7（ボタン追加）
    
    **実装済み機能**:
    - prompt_sets構造による名前付きプロンプトセット管理
    - 旧形式から新形式への自動データ移行
    - 現在のプロンプトセット表示UI
    - 後方互換性保持
    
    **重要な学習事項**:
    - Gradio Numberコンポーネント参照一貫性の原則
    - 段階的実装による安全なUI追加手法
    - タブ間コンポーネント参照の適切な管理方法

### 📁 ファイル構成
```
web-automate/
├── main.py                 # メインプログラム（コアロジック）
├── gradio_gui.py          # Gradio Web GUI インターフェース
├── debug_regenerate.py    # 再生成ボタン検出デバッグツール
├── requirements.txt        # 依存関係（Gradio追加）
├── .gitignore             # Git除外設定
├── README.md              # インストール・使用方法
├── automation.log         # 実行ログ
├── gui_settings.json      # GUI設定永続化ファイル（自動生成）
├── outputs/               # 生成されたMarkdownファイル
│   ├── output_001_YYYYMMDD_HHMMSS.md
│   ├── output_002_YYYYMMDD_HHMMSS.md
│   └── ...
└── CLAUDE.md             # このファイル
```

### 🎯 主要クラス・メソッド

#### ChromeAutomationTool クラス（main.py）
- `launch_chrome()` - Chrome起動・Genspark.ai自動オープン
- `find_text_input()` - テキスト入力フィールド検出
- `find_submit_button()` - 送信ボタン検出
- `find_regenerate_button()` - 再生成ボタン検出・クリック
- `handle_regenerate_with_retry()` - 再生成リトライ処理（最大20回）
- `process_continuous_prompts()` - 継続的プロンプト処理ループ
- `process_single_prompt(save_file=True)` - 単一プロンプト処理
- `get_latest_message_content(wait_for_streaming=True)` - 最新応答取得
- `get_response_text()` - 応答テキスト取得（エラー検出付き）
- `wait_for_streaming_response_complete()` - ストリーミング完了待機
- `clean_response_text()` - 応答テキストクリーンアップ

#### AutomationGUI クラス（gradio_gui.py）
- `start_automation()` - GUI からの自動化開始
- `_run_automation()` - バックグラウンド自動化実行
- `start_prompt_flow()` - プロンプトフロー自動化開始
- `_run_prompt_flow()` - プロンプトフローバックグラウンド実行
- `_send_prompt_with_retry()` - プロンプト送信・リトライ処理
- `load_settings()` - JSON設定ファイル読み込み
- `save_settings()` - JSON設定ファイル保存
- `add_to_list()` - プロンプトリストに項目追加
- `remove_from_list()` - プロンプトリストから項目削除
- `edit_list_item()` - リスト項目編集
- `get_list_display()` - リスト表示用文字列取得
- `get_random_prompt()` - リストからランダムプロンプト選択
- `stop_automation()` - 自動化停止・Chrome終了
- `get_status_update()` - リアルタイムステータス更新
- `get_response_update()` - 応答内容更新

### 🚀 使用方法

#### コマンドライン版
```bash
python main.py
```
1. Chrome自動起動・Genspark.ai自動オープン
2. ページ読み込み完了後Enterキー押下
3. プロンプト入力・送信・応答保存を繰り返し
4. `quit` または `exit` で終了

#### Web GUI版（推奨）
```bash
python gradio_gui.py
```

**基本プロンプト送信**:
1. ブラウザで `http://127.0.0.1:7860` にアクセス
2. URL・プロンプト・フォールバックメッセージを設定
3. 「🚀 プロンプト送信」をクリック
4. リアルタイムでステータス・応答を確認
5. 「🛑 停止」でChrome終了

**プロンプトフロー機能**:
1. プロンプトA（初期）、B（追加情報要求）、C（承認）を設定
2. 「🅰️ リストを使用」等のチェックボックスでランダム選択ON/OFF
3. 「🔄 プロンプトフロー開始」をクリック
4. A→B→C→B→C...の無限循環が自動実行
5. 各プロンプト間5-30秒ランダム待機
6. 全応答が自動的にMarkdownファイル保存
7. 「⏹️ フロー停止」で停止

**プロンプトリスト管理機能（Phase 2新機能）**:
1. 「📝 プロンプトリストの編集」タブを開く
2. A/B/C各プロンプトのリストを独立管理
3. ➕追加: 新しいプロンプトをリストに追加
4. ✏️編集: インデックス指定でリスト項目を編集
5. 🗑️削除: インデックス指定でリスト項目を削除
6. メインタブで「リストを使用」ON時、ランダム選択実行

### 🛠️ 技術的な課題と解決策

#### 1. 再生成エラーの自動検出・処理
**課題**: サーバー側エラーで「応答を再生成」ボタンが表示される
**解決**: 
- XPath・CSS セレクターによる再生成ボタン検出
- JavaScript強制クリック（通常クリック・MouseEvent）
- 最大20回の自動リトライ・ランダム待機時間

#### 2. フォールバック処理の信頼性
**課題**: エラー時のフォールバックメッセージ送信とThinking状態の混在
**解決**:
- `wait_for_streaming=False` でThinking状態を除外
- エラーメッセージの正確な識別
- 連続フォールバック処理（最大20回）

#### 3. ストリーミングタイムアウトの回避
**課題**: エラー状態時の60秒タイムアウトと15秒待機
**解決**:
- エラー検出時のストリーミング処理無効化
- デッドコード除去による即座のフォールバック移行
- 適切な要素選択ロジック分離

#### 4. GUI とコアロジックの統合
**課題**: リアルタイム状態表示とバックグラウンド処理の同期
**解決**:
- Queue ベースのステータス・応答管理
- Chrome持続性によるセッション維持
- 詳細な進捗表示とエラーハンドリング

#### 5. Gradio Numberコンポーネントのイベントハンドラー不整合エラー（2025-07-21）
**課題**: `ValueError: An event handler didn't receive enough input values (needed: 1, got: 0)`
**根本原因**:
- 同じコンテキスト内でNumberコンポーネント（例：`bc_loop_input`）を参照するイベントハンドラーと参照しないイベントハンドラーが混在
- Gradio内部でのコンポーネントインデックス管理に不整合が発生
- 特に複数のNumberコンポーネントがある環境（プロンプトリスト編集タブ等）で発生しやすい

**解決**:
- **一貫性の原則**: 同一コンテキスト内の全イベントハンドラーでNumberコンポーネント参照を統一
- ダミーinputの追加: `inputs=[bc_loop_input]` でコンポーネント参照を一致させる
- 例: `flow_stop_btn.click(fn=lambda bc_count: gui.stop_automation(), inputs=[bc_loop_input], outputs=[...])`

**予防策**:
- Numberコンポーネントを含むエリアでボタンを追加する際は必ずNumberコンポーネントをinputsに含める
- レイアウト変更時はコンポーネント参照順序に注意
- 段階的実装でエラー箇所を特定する

### ⚙️ 設定・環境
- **対象サイト**: Genspark.ai (`https://www.genspark.ai/agents?type=moa_chat`)
- **対応OS**: macOS (M1/M2), Linux, Windows
- **Python**: 3.8+
- **主要依存**: selenium==4.15.2, gradio>=4.0.0, webdriver-manager==4.0.1
- **GUI アクセス**: http://127.0.0.1:7860 (localhost のみ)

### 🔍 デバッグ・ログ
- `automation.log` に詳細ログ出力
- DEBUG レベルでDOM構造解析
- リトライ回数・進捗の可視化
- `debug_regenerate.py` で再生成ボタン検出テスト

### 📝 TODO（今後の改善予定）
- [ ] 他のAIチャットサイト対応
- [ ] 応答フォーマットのカスタマイズ
- [x] ~~エラー時の自動リトライ機能強化~~
- [x] ~~GUI インターフェース~~
- [x] ~~設定永続化機能（Phase 0）~~
- [x] ~~プロンプトフロー自動化システム（Phase 1）~~
- [x] ~~プロンプトリスト管理機能（Phase 2）~~
  - [x] ~~プロンプトリスト編集タブ~~
  - [x] ~~A/B/Cプロンプトのリスト管理（CRUD操作）~~
  - [x] ~~ランダムプロンプト選択機能~~
  - [x] ~~リスト永続化ストレージ~~
- [ ] 応答品質評価・フィルタリング機能
- [ ] プロンプト実行履歴・統計機能
- [ ] エクスポート・インポート機能（プロンプトリスト）

### 🎉 現在のステータス
**動作状況**: 基本機能完全実装完了 + Phase 0-2 拡張機能実装完了。設定永続化、プロンプトフロー自動化、プロンプトリスト管理まで対応済み。

**主要機能**:
- ✅ 基本的な自動化処理
- ✅ 再生成エラー自動検出・リトライ（最大20回）
- ✅ Gradio Web GUI インターフェース
- ✅ 連続フォールバック処理
- ✅ ストリーミングタイムアウト回避
- ✅ エラーメッセージ正確識別
- ✅ Thinking終了後のデュアルエラー検出システム
- ✅ 詳細なストリーミング処理フロー可視化
- ✅ 簡素化されたEnterキー専用送信処理
- ✅ 再生成ボタン早期検出システム（最優先チェック）
- ✅ 統一された再生成ボタン検出ロジック（AND条件）
- ✅ Thinking終了判定の詳細分析機能
- ✅ 長時間応答対応（300秒タイムアウト、100回リトライ）
- ✅ **設定永続化機能（Phase 0）**: フォールバックメッセージデフォルトON、JSON設定保存・復元
- ✅ **プロンプトフロー自動化システム（Phase 1）**: A→(B→C)*無限循環、ランダム待機、自動ファイル保存
- ✅ **プロンプトリスト管理システム（Phase 2）**: 専用タブ、CRUD操作、ランダム選択、永続化ストレージ

**最新の改善（2025-07-20 安定版）**: 
- 再生成ボタン検出を最優先にしてエラーの早期発見を実現
- 軽量版・フルバージョンの検出ロジック完全統一（厳格なAND条件）
- Thinking終了判定の詳細分析機能で`█`文字消失パターンを確認
- 長時間応答に対応するタイムアウト・リトライ回数の大幅拡張
- 3回連続テスト成功により安定性を確認

**検証・デバッグ状況**:
- ✅ Thinking状態の検出・終了判定ロジック（`█`文字の動作解明）
- ✅ 再生成ボタンの早期検出・統一ロジック
- ✅ ストリーミング待機の開始・スキップ判定
- ✅ エラー検出の2つの手法（テキスト+DOM要素）
- ✅ メッセージ送信の最適化（無駄な試行除去）
- ✅ 長時間応答処理の安定性

### 🚀 **緊急ロールバック完了記録**
**実行日時**: 2025-07-20 23:30
- **原因**: Gradio 4.44.1互換性エラー再発（function index mismatch）
- **対応**: 41d0ced安定版への即座ロールバック
- **影響範囲**: GitHub master + 全検証環境
- **復旧時間**: 即座（安定版使用により問題解消）
- **今後の方針**: 41d0ced基準の安定運用継続

---
*Last updated: 2025-07-20 23:30 (緊急ロールバック完了)*